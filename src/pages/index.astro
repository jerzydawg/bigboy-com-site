---
import Layout from '../layouts/Layout.astro';
import { supabase } from '../lib/supabase';
import { createCitySlug } from '../lib/slug-utils.js';
import { getSiteConfig, getDesignDNA, getSiteName, getKeyword, getDomain, getSiteURL } from '../lib/site-config';
import { generateCSSVariables, getGoogleFontsURL } from '../lib/design-dna';

export const prerender = false;

// Get site configuration
const siteConfig = getSiteConfig();
const designDNA = getDesignDNA();
const siteName = getSiteName();
const keyword = getKeyword();
const domain = getDomain();
const siteURL = getSiteURL();

// Smart keyword formatting - avoid "Get Your my gov phone" grammar issues
const keywordLower = keyword.toLowerCase();
const keywordDisplay = keywordLower.startsWith('my ') || keywordLower.startsWith('your ') || keywordLower.startsWith('a ') || keywordLower.startsWith('the ')
  ? keyword
  : `Your ${keyword}`;

// Generate dynamic CSS and fonts
const cssVariables = generateCSSVariables(designDNA);
const fontsURL = getGoogleFontsURL(designDNA);

// Fetch top 20 cities by population for Popular Cities section
let popularCities: Array<{name: string; population: number; state_abbr: string}> = [];
if (supabase) {
  try {
    const { data } = await supabase
      .from('cities')
      .select('name, population, states(abbreviation)')
      .order('population', { ascending: false })
      .limit(20);
    
    if (data) {
      popularCities = data.map((city: any) => ({
        name: city.name,
        population: city.population,
        state_abbr: city.states?.abbreviation || ''
      })).filter((c: any) => c.state_abbr);
    }
  } catch (e) {
    console.log('Could not fetch popular cities');
  }
}

// All 50 states for Browse by State section
const allStates = [
  { name: 'Alabama', abbr: 'AL' }, { name: 'Alaska', abbr: 'AK' }, { name: 'Arizona', abbr: 'AZ' },
  { name: 'Arkansas', abbr: 'AR' }, { name: 'California', abbr: 'CA' }, { name: 'Colorado', abbr: 'CO' },
  { name: 'Connecticut', abbr: 'CT' }, { name: 'Delaware', abbr: 'DE' }, { name: 'Florida', abbr: 'FL' },
  { name: 'Georgia', abbr: 'GA' }, { name: 'Hawaii', abbr: 'HI' }, { name: 'Idaho', abbr: 'ID' },
  { name: 'Illinois', abbr: 'IL' }, { name: 'Indiana', abbr: 'IN' }, { name: 'Iowa', abbr: 'IA' },
  { name: 'Kansas', abbr: 'KS' }, { name: 'Kentucky', abbr: 'KY' }, { name: 'Louisiana', abbr: 'LA' },
  { name: 'Maine', abbr: 'ME' }, { name: 'Maryland', abbr: 'MD' }, { name: 'Massachusetts', abbr: 'MA' },
  { name: 'Michigan', abbr: 'MI' }, { name: 'Minnesota', abbr: 'MN' }, { name: 'Mississippi', abbr: 'MS' },
  { name: 'Missouri', abbr: 'MO' }, { name: 'Montana', abbr: 'MT' }, { name: 'Nebraska', abbr: 'NE' },
  { name: 'Nevada', abbr: 'NV' }, { name: 'New Hampshire', abbr: 'NH' }, { name: 'New Jersey', abbr: 'NJ' },
  { name: 'New Mexico', abbr: 'NM' }, { name: 'New York', abbr: 'NY' }, { name: 'North Carolina', abbr: 'NC' },
  { name: 'North Dakota', abbr: 'ND' }, { name: 'Ohio', abbr: 'OH' }, { name: 'Oklahoma', abbr: 'OK' },
  { name: 'Oregon', abbr: 'OR' }, { name: 'Pennsylvania', abbr: 'PA' }, { name: 'Rhode Island', abbr: 'RI' },
  { name: 'South Carolina', abbr: 'SC' }, { name: 'South Dakota', abbr: 'SD' }, { name: 'Tennessee', abbr: 'TN' },
  { name: 'Texas', abbr: 'TX' }, { name: 'Utah', abbr: 'UT' }, { name: 'Vermont', abbr: 'VT' },
  { name: 'Virginia', abbr: 'VA' }, { name: 'Washington', abbr: 'WA' }, { name: 'West Virginia', abbr: 'WV' },
  { name: 'Wisconsin', abbr: 'WI' }, { name: 'Wyoming', abbr: 'WY' }, { name: 'District of Columbia', abbr: 'DC' }
];

// SEO Meta Tags
const title = `${keyword} | ${siteName} - Free Phone & Service Programs 2025`;
const description = `Get your ${keyword.toLowerCase()} today. Check eligibility in 2 minutes. No cost, no hidden fees. ${siteName} helps you access free phone programs.`;
const canonical = `${siteURL}/`;
---

<Layout 
  title={title}
  description={description}
  canonical={canonical}
  cssVariables={cssVariables}
  fontsURL={fontsURL}
>
  <style>
    .stats-counter {
      animation: countUp 2s ease-out;
    }
    @keyframes countUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .step-card:hover {
      transform: translateY(-4px);
    }
  </style>

  <!-- Hero Section -->
  <section class="py-20 px-4" style={`background: linear-gradient(135deg, ${designDNA.colors.primary}15, ${designDNA.colors.primary}05);`}>
    <div class="container mx-auto text-center max-w-4xl">
      <h1 class="text-4xl md:text-6xl font-bold text-gray-900 mb-6">
        my gov phone - Get Yours Today
      </h1>
      <p class="text-xl text-gray-700 mb-8 max-w-2xl mx-auto leading-relaxed">
        Access your my gov phone through trusted free phone programs. Skip the monthly bills and credit checks. Over 2 million Americans already have their free smartphone with unlimited talk, text, and data through {siteName}.
      </p>
      
      <!-- Stats Row -->
      <div class="grid grid-cols-3 gap-6 md:gap-12 mb-10 max-w-2xl mx-auto">
        <div class="stats-counter">
          <div class="text-2xl md:text-3xl font-bold" style={`color: ${designDNA.colors.primary};`}>2M+</div>
          <div class="text-sm md:text-base text-gray-600">Helped</div>
        </div>
        <div class="stats-counter">
          <div class="text-2xl md:text-3xl font-bold" style={`color: ${designDNA.colors.primary};`}>$0</div>
          <div class="text-sm md:text-base text-gray-600">Cost</div>
        </div>
        <div class="stats-counter">
          <div class="text-2xl md:text-3xl font-bold" style={`color: ${designDNA.colors.primary};`}>2 Min</div>
          <div class="text-sm md:text-base text-gray-600">Application</div>
        </div>
      </div>

      <a href="/apply/" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-gray-900 font-bold py-3 px-6 rounded-xl shadow-lg inline-block">
        Check If You Qualify Now
      </a>
    </div>
  </section>

  <!-- How It Works -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Get Your {keyword} in 3 Easy Steps</h2>
        <p class="text-gray-600 max-w-2xl mx-auto">Simple process to get your free phone and service activated today.</p>
      </div>
      
      <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
        <div class="step-card text-center p-6 rounded-xl bg-gray-50 transition-all duration-300">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-white font-bold text-xl" style={`background-color: ${designDNA.colors.primary};`}>1</div>
          <h3 class="text-xl font-semibold mb-3">Check Eligibility</h3>
          <p class="text-gray-600">Answer a few quick questions about your household income or participation in qualifying programs like SNAP or Medicaid.</p>
        </div>
        
        <div class="step-card text-center p-6 rounded-xl bg-gray-50 transition-all duration-300">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-white font-bold text-xl" style={`background-color: ${designDNA.colors.primary};`}>2</div>
          <h3 class="text-xl font-semibold mb-3">Quick Approval</h3>
          <p class="text-gray-600">Get instant approval in most cases. We verify your information and connect you with the best provider in your area.</p>
        </div>
        
        <div class="step-card text-center p-6 rounded-xl bg-gray-50 transition-all duration-300">
          <div class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center text-white font-bold text-xl" style={`background-color: ${designDNA.colors.primary};`}>3</div>
          <h3 class="text-xl font-semibold mb-3">Get Your Phone</h3>
          <p class="text-gray-600">Receive your free smartphone by mail within 5-10 business days, or pick one up at a local store near you.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Programs Overview -->
  <section class="py-16 bg-gray-50">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">Free Phone Programs Available</h2>
        <p class="text-gray-600 max-w-2xl mx-auto">Multiple federal programs ensure you can get your my gov phone regardless of your situation.</p>
      </div>
      
      <div class="grid md:grid-cols-3 gap-8 max-w-4xl mx-auto">
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <h3 class="text-xl font-semibold mb-3" style={`color: ${designDNA.colors.primary};`}>Lifeline Program</h3>
          <p class="text-gray-600 mb-4">The original government program providing discounted phone service since 1985. Get unlimited talk and text plus data allowance every month at zero cost to qualified households nationwide.</p>
          <a href="/lifeline-program/" class="text-[var(--color-primary)] hover:underline font-medium">Learn About Lifeline →</a>
        </div>
        
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <h3 class="text-xl font-semibold mb-3" style={`color: ${designDNA.colors.primary};`}>ACP Program</h3>
          <p class="text-gray-600 mb-4">Affordable Connectivity Program offers enhanced internet discounts and device subsidies. Perfect for families needing high-speed data for work, school, and staying connected with loved ones.</p>
          <a href="/acp-program/" class="text-[var(--color-primary)] hover:underline font-medium">Explore ACP Benefits →</a>
        </div>
        
        <div class="bg-white rounded-xl p-6 shadow-sm">
          <h3 class="text-xl font-semibold mb-3" style={`color: ${designDNA.colors.primary};`}>Tribal Programs</h3>
          <p class="text-gray-600 mb-4">Enhanced federal support for Native American communities living on tribal lands. Receive additional monthly discounts and priority access to the latest smartphones and unlimited service plans.</p>
          <a href="/tribal-programs/" class="text-[var(--color-primary)] hover:underline font-medium">View Tribal Options →</a>
        </div>
      </div>
    </div>
  </section>

  <!-- Qualification Section -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="text-
---
import Layout from '../layouts/Layout.astro';
import HeroSelector from '../components/HeroSelector.astro';
import HowItWorks from '../components/HowItWorks.astro';
import { supabase } from '../lib/supabase';
import { createCitySlug } from '../lib/slug-utils.js';
import { getSiteConfig, getDesignDNA, getSiteName, getKeyword, getDomain, getSiteURL } from '../lib/site-config';
import { generateCSSVariables, getGoogleFontsURL } from '../lib/design-dna';
import { getContentVariations } from '../lib/city-content-variations';

export const prerender = false;

// Get site configuration
const siteConfig = getSiteConfig();
const designDNA = getDesignDNA();
const siteName = getSiteName();
const keyword = getKeyword();
const domain = getDomain();
const siteURL = getSiteURL();

// Get content variations for this domain
const content = getContentVariations(domain);

// Generate dynamic CSS and fonts
const cssVariables = generateCSSVariables(designDNA);
const fontsURL = getGoogleFontsURL(designDNA);

// Fetch top 20 cities by population for Popular Cities section
let popularCities: Array<{name: string; population: number; state_abbr: string}> = [];
if (supabase) {
  try {
    const { data } = await supabase
      .from('cities')
      .select('name, population, states(abbreviation)')
      .order('population', { ascending: false })
      .limit(20);
    
    if (data) {
      popularCities = data.map((city: any) => ({
        name: city.name,
        population: city.population,
        state_abbr: city.states?.abbreviation || ''
      })).filter((c: any) => c.state_abbr);
    }
  } catch (e) {
    console.log('Could not fetch popular cities');
  }
}

// All 50 states for Browse by State section
const allStates = [
  { name: 'Alabama', abbr: 'AL' }, { name: 'Alaska', abbr: 'AK' }, { name: 'Arizona', abbr: 'AZ' },
  { name: 'Arkansas', abbr: 'AR' }, { name: 'California', abbr: 'CA' }, { name: 'Colorado', abbr: 'CO' },
  { name: 'Connecticut', abbr: 'CT' }, { name: 'Delaware', abbr: 'DE' }, { name: 'Florida', abbr: 'FL' },
  { name: 'Georgia', abbr: 'GA' }, { name: 'Hawaii', abbr: 'HI' }, { name: 'Idaho', abbr: 'ID' },
  { name: 'Illinois', abbr: 'IL' }, { name: 'Indiana', abbr: 'IN' }, { name: 'Iowa', abbr: 'IA' },
  { name: 'Kansas', abbr: 'KS' }, { name: 'Kentucky', abbr: 'KY' }, { name: 'Louisiana', abbr: 'LA' },
  { name: 'Maine', abbr: 'ME' }, { name: 'Maryland', abbr: 'MD' }, { name: 'Massachusetts', abbr: 'MA' },
  { name: 'Michigan', abbr: 'MI' }, { name: 'Minnesota', abbr: 'MN' }, { name: 'Mississippi', abbr: 'MS' },
  { name: 'Missouri', abbr: 'MO' }, { name: 'Montana', abbr: 'MT' }, { name: 'Nebraska', abbr: 'NE' },
  { name: 'Nevada', abbr: 'NV' }, { name: 'New Hampshire', abbr: 'NH' }, { name: 'New Jersey', abbr: 'NJ' },
  { name: 'New Mexico', abbr: 'NM' }, { name: 'New York', abbr: 'NY' }, { name: 'North Carolina', abbr: 'NC' },
  { name: 'North Dakota', abbr: 'ND' }, { name: 'Ohio', abbr: 'OH' }, { name: 'Oklahoma', abbr: 'OK' },
  { name: 'Oregon', abbr: 'OR' }, { name: 'Pennsylvania', abbr: 'PA' }, { name: 'Rhode Island', abbr: 'RI' },
  { name: 'South Carolina', abbr: 'SC' }, { name: 'South Dakota', abbr: 'SD' }, { name: 'Tennessee', abbr: 'TN' },
  { name: 'Texas', abbr: 'TX' }, { name: 'Utah', abbr: 'UT' }, { name: 'Vermont', abbr: 'VT' },
  { name: 'Virginia', abbr: 'VA' }, { name: 'Washington', abbr: 'WA' }, { name: 'West Virginia', abbr: 'WV' },
  { name: 'Wisconsin', abbr: 'WI' }, { name: 'Wyoming', abbr: 'WY' }, { name: 'District of Columbia', abbr: 'DC' }
];

// SEO Meta Tags - Dynamic from site config
const title = `${keyword} | ${siteName} - Free Phone & Service Programs 2025`;
const description = `Get your ${keyword.toLowerCase()} today. Check eligibility in 2 minutes. No cost, no hidden fees. ${siteName} helps you access free phone programs.`;
const canonical = `${siteURL}/`;
---

<Layout title={title} description={description} canonical={canonical}>
  <main class="min-h-screen">
    <!-- Hero Section - Dynamic based on design style -->
    <HeroSelector />

    <!-- How It Works -->
    <HowItWorks />

    <!-- Programs Overview -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-900 mb-12">
          Free Government Phone Programs
        </h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
          <!-- Lifeline Program -->
          <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition duration-300">
            <div class="text-4xl mb-4" style={`color: ${designDNA.colors.primary};`}>{content.icons.phone}</div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">Lifeline {keyword}</h3>
            <p class="text-gray-600 mb-4">
              Federal phone assistance program for qualifying households. 
              Receive monthly discounts on communication services.
            </p>
            <ul class="text-sm text-gray-600 mb-4 space-y-1">
              <li>‚Ä¢ Monthly service discount</li>
              <li>‚Ä¢ Available nationwide</li>
              <li>‚Ä¢ Income-based qualification</li>
            </ul>
            <a href="/lifeline-program" class="font-semibold hover:opacity-80" style={`color: ${designDNA.colors.primary};`}>
              Learn More ‚Üí
            </a>
          </div>

          <!-- ACP Program -->
          <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition duration-300">
            <div class="text-4xl mb-4" style={`color: ${designDNA.colors.accent};`}>{content.icons.money}</div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">Affordable Connectivity Program</h3>
            <p class="text-gray-600 mb-4">
              Federal digital access initiative providing internet 
              and device assistance to eligible households.
            </p>
            <ul class="text-sm text-gray-600 mb-4 space-y-1">
              <li>‚Ä¢ Free internet service</li>
              <li>‚Ä¢ One-time device discount</li>
              <li>‚Ä¢ Expanded eligibility criteria</li>
            </ul>
            <a href="/acp-program" class="font-semibold hover:opacity-80" style={`color: ${designDNA.colors.accent};`}>
              Learn More ‚Üí
            </a>
          </div>

          <!-- Tribal Programs -->
          <div class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition duration-300">
            <div class="text-4xl mb-4" style={`color: ${designDNA.colors.secondary};`}>{content.icons.support}</div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">Tribal Free Government Phone</h3>
            <p class="text-gray-600 mb-4">
              Specialized federal assistance for tribal communities with 
              enhanced benefits and expanded qualification criteria.
            </p>
            <ul class="text-sm text-gray-600 mb-4 space-y-1">
              <li>‚Ä¢ Enhanced monthly discount</li>
              <li>‚Ä¢ Tribal land benefits</li>
              <li>‚Ä¢ Community-specific support</li>
            </ul>
            <a href="/tribal-programs" class="font-semibold hover:opacity-80" style={`color: ${designDNA.colors.secondary};`}>
              Learn More ‚Üí
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Benefits Section - Dynamic content -->
    <section class="py-16 bg-white">
      <div class="container mx-auto px-4">
        <h2 class="text-3xl md:text-4xl font-bold text-center text-gray-900 mb-12">
          Why Choose {siteName}?
        </h2>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
          <div class="text-center">
            <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style={`background-color: ${designDNA.colors.primary}20;`}>
              <span class="text-2xl">{content.icons.money}</span>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">{content.featureTitles.noCost}</h3>
            <p class="text-gray-600">{content.valueProps[0]}</p>
          </div>
          <div class="text-center">
            <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style={`background-color: ${designDNA.colors.accent}20;`}>
              <span class="text-2xl">{content.icons.phone}</span>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">{content.featureTitles.freePhone}</h3>
            <p class="text-gray-600">Receive a modern smartphone device at no additional cost.</p>
          </div>
          <div class="text-center">
            <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style={`background-color: ${designDNA.colors.secondary}20;`}>
              <span class="text-2xl">üåê</span>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">{content.featureTitles.connectivity}</h3>
            <p class="text-gray-600">Stay connected with unlimited talk, text, and data access.</p>
          </div>
          <div class="text-center">
            <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4" style={`background-color: ${designDNA.colors.accent}20;`}>
              <span class="text-2xl">{content.icons.speed}</span>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">{content.featureTitles.approval}</h3>
            <p class="text-gray-600">Streamlined application process with immediate approval.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Browse by State Section -->
    <section class="py-16 bg-gray-50">
      <div class="container mx-auto px-4">
        <div class="text-center mb-12">
          <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            Browse by State
          </h2>
          <p class="text-gray-600 max-w-2xl mx-auto">
            Government phone programs are available in all 50 states. Find free phone service in your area.
          </p>
        </div>
        
        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-13 gap-2 mb-8">
          {allStates.map((state) => (
            <a 
              href={`/${state.abbr.toLowerCase()}/`}
              class="state-btn group flex flex-col items-center justify-center p-3 bg-white rounded-lg text-gray-900 transition-all duration-200 shadow-sm hover:shadow-md border border-gray-200"
              title={`${keyword} in ${state.name}`}
            >
              <span class="font-bold text-lg group-hover:scale-110 transition-transform">{state.abbr}</span>
            </a>
          ))}
        </div>
        
        <div class="text-center">
          <a href="/states/" class="inline-flex items-center px-6 py-3 text-white font-semibold rounded-lg transition-colors" style={`background-color: ${designDNA.colors.primary};`}>
            View All States & Cities
            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </div>
      </div>
    </section>

    <!-- Popular Cities Section -->
    {popularCities.length > 0 && (
      <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
          <div class="text-center mb-12">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              Most Popular Cities
            </h2>
            <p class="text-gray-600 max-w-2xl mx-auto">
              Residents in these cities are accessing {keyword.toLowerCase()} through {siteName}.
            </p>
          </div>
          
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
            {popularCities.map((city) => (
              <a 
                href={`/${city.state_abbr.toLowerCase()}/${createCitySlug(city.name)}/`}
                class="group block bg-white rounded-xl p-4 shadow-sm hover:shadow-lg transition-all duration-300 border border-gray-200"
                style={`--hover-border-color: ${designDNA.colors.primary};`}
              >
                <div class="flex items-center justify-between mb-2">
                  <h3 class="font-semibold text-gray-900 group-hover:opacity-80 transition-colors truncate">
                    {city.name}
                  </h3>
                  <span class="text-xs font-bold px-2 py-1 rounded" style={`background-color: ${designDNA.colors.primary}20; color: ${designDNA.colors.primary};`}>
                    {city.state_abbr}
                  </span>
                </div>
                <p class="text-sm text-gray-500">
                  {city.population?.toLocaleString()} residents
                </p>
              </a>
            ))}
          </div>
          
          <div class="text-center mt-8">
            <a href="/states/" class="font-semibold hover:opacity-80" style={`color: ${designDNA.colors.primary};`}>
              Explore all cities ‚Üí
            </a>
          </div>
        </div>
      </section>
    )}

    <!-- CTA Section - Dynamic color -->
    <section class="text-white py-16" style={`background-color: ${designDNA.colors.primary};`}>
      <div class="container mx-auto px-4 text-center">
        <h2 class="text-3xl md:text-4xl font-bold mb-6">
          Ready to Get Your {keyword}?
        </h2>
        <p class="text-xl mb-8 max-w-2xl mx-auto opacity-90">
          {content.footerTagline}. {content.heroSubtext}
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="/apply" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-4 px-8 rounded-lg text-lg transition duration-300">
            {content.ctaButton}
          </a>
          <a href="/providers" class="bg-transparent border-2 border-white hover:bg-white text-white hover:text-gray-900 font-bold py-4 px-8 rounded-lg text-lg transition duration-300">
            View Providers
          </a>
          <a href="/eligibility" class="bg-transparent border-2 border-white hover:bg-white text-white hover:text-gray-900 font-bold py-4 px-8 rounded-lg text-lg transition duration-300">
            Check Eligibility
          </a>
        </div>
      </div>
    </section>
  </main>
</Layout>
